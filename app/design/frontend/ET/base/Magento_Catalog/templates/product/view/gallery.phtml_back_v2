<?php
/**
 * Grid Gallery with Per-Image Canvas Coordinates from ALT
 * Magento 2.4.8
 *
 * @var $block \Magento\Catalog\Block\Product\View\Gallery
 * @var $escaper \Magento\Framework\Escaper
 */

$product = $block->getProduct();
$helper  = $block->getData('imageHelper');
$images  = $block->getGalleryImages()->getItems();
?>

<div class="product-media-wrapper">

    <!-- Backend-only canvas -->
    <canvas id="imageCanvas" style="display:none;"></canvas>

    <!-- IMAGE GRID -->
    <div class="image-grid" id="imageGrid">
        <?php foreach ($images as $image): ?>
            <?php
            $imageUrl = $image->getData('medium_image_url')
                ?: $helper->getDefaultPlaceholderUrl('image');

            // ALT text = your coordinate storage
            $altText = $image->getLabel() ?: 'x=0.35;y=0.35;w=0.3;h=0.3';
            ?>
            <div class="grid-item">
                <img
                    class="grid-image"
                    src="<?= /* @noEscape */ $imageUrl ?>"
                    alt="<?= $escaper->escapeHtmlAttr($altText) ?>"
                    loading="eager"
                />
            </div>
        <?php endforeach; ?>
    </div>

    <!-- COLOR SWATCHES -->
    <div class="swatches">
        <div class="swatch" data-action="reset" style="background:#777"></div>
        <div class="swatch" data-color="#ff005a" style="background:#ff005a"></div>
        <div class="swatch" data-color="#1e5eff" style="background:#1e5eff"></div>
        <div class="swatch" data-color="#ffaa00" style="background:#ffaa00"></div>
        <div class="swatch" data-color="#00ff88" style="background:#00ff88"></div>
    </div>

</div>

<!-- =========================
     STYLES
     ========================= -->
<style>
.product-media-wrapper {
    max-width: 900px;
    margin: auto;
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
}

.grid-item {
    overflow: hidden;
    border-radius: 8px;
}

.grid-image {
    width: 100%;
    display: block;
}

.swatches {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
}

.swatch {
    width: 42px;
    height: 42px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid #ccc;
}

.swatch.active {
    border-color: #000;
}
</style>

<!-- =========================
     CANVAS SCRIPT (ALT-BASED)
     ========================= -->
<script>
require(['jquery'], function ($) {

    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');

    /* =========================
       Parse RECT from ALT
       ========================= */
    function parseRectFromAlt(alt) {

        // default fallback
        const rect = { x: 0.35, y: 0.35, w: 0.3, h: 0.3 };

        if (!alt) return rect;

        alt.split(';').forEach(pair => {
            const [key, value] = pair.split('=');
            if (rect.hasOwnProperty(key)) {
                const num = parseFloat(value);
                if (!isNaN(num)) rect[key] = num;
            }
        });

        return rect;
    }

    function waitForImage(img) {
        return new Promise(resolve => {
            if (img.complete && img.naturalWidth > 0) resolve();
            else img.onload = resolve;
        });
    }

    function processImage(src, rect, color) {
        return new Promise(resolve => {

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = src.split('?')[0];

            img.onload = () => {
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                if (color) {
                    ctx.globalCompositeOperation = 'multiply';
                    ctx.globalAlpha = 0.7;
                    ctx.fillStyle = color;
                    ctx.fillRect(
                        canvas.width * rect.x,
                        canvas.height * rect.y,
                        canvas.width * rect.w,
                        canvas.height * rect.h
                    );
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 1;
                }

                resolve(canvas.toDataURL('image/png'));
            };
        });
    }

    async function applyColor(color) {

        const images = document.querySelectorAll('.grid-image');

        for (const imgEl of images) {

            await waitForImage(imgEl);

            if (!imgEl.dataset.originalSrc) {
                imgEl.dataset.originalSrc = imgEl.src;
            }

            const rect = parseRectFromAlt(imgEl.alt);
            imgEl.src = await processImage(
                imgEl.dataset.originalSrc,
                rect,
                color
            );
        }
    }

    function resetImages() {
        document.querySelectorAll('.grid-image').forEach(img => {
            if (img.dataset.originalSrc) {
                img.src = img.dataset.originalSrc;
            }
        });
    }

    /* =========================
       SWATCH CLICK
       ========================= */
    $('.swatch').on('click', async function () {

        $('.swatch').removeClass('active');
        $(this).addClass('active');

        const action = $(this).data('action');
        const color  = $(this).data('color');

        if (action === 'reset') {
            resetImages();
            return;
        }

        if (color) {
            await applyColor(color);
        }
    });

});
</script>

