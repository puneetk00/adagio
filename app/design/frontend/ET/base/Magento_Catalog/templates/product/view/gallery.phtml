<?php
/**
 * Full Canvas Gallery with Color + Black & White
 * Magento 2.4.8
 *
 * @var $block \Magento\Catalog\Block\Product\View\Gallery
 * @var $escaper \Magento\Framework\Escaper
 */

$helper = $block->getData('imageHelper');
$images = $block->getGalleryImages()->getItems();
?>

<div class="product-media-wrapper">

    <!-- Hidden backend canvas -->
    <canvas id="imageCanvas" style="display:none;"></canvas>

    <!-- IMAGE GRID -->
    <div class="image-grid">
        <?php foreach ($images as $image): ?>
            <?php
            $imageUrl = $image->getData('medium_image_url')
                ?: $helper->getDefaultPlaceholderUrl('image');

            /**
             * ALT FORMAT:
             * x=0.35;y=0.35;w=0.3;h=0.3
             */
            $alt = $image->getLabel() ?: 'x=0.35;y=0.35;w=0.3;h=0.3';
            ?>
            <div class="grid-item">
                <img
                    class="grid-image"
                    src="<?= /* @noEscape */ $imageUrl ?>"
                    alt="<?= $escaper->escapeHtmlAttr($alt) ?>"
                    loading="eager"
                />
            </div>
        <?php endforeach; ?>
    </div>

    <!-- COLOR / BW SWATCHES -->
    <div class="swatches">
        <div class="swatch" data-color="#ff005a" style="background:#ff005a"></div>
        <div class="swatch" data-color="#1e5eff" style="background:#1e5eff"></div>
        <div class="swatch" data-color="#ffaa00" style="background:#ffaa00"></div>
        <div class="swatch" data-color="#00ff88" style="background:#00ff88"></div>
        <div class="swatch" data-action="bw" title="Black & White" style="background:#000"></div>
        <div class="swatch" data-action="reset" title="Reset" style="background:#777"></div>
    </div>

</div>

<!-- =====================
     STYLES
     ===================== -->
<style>
.product-media-wrapper {
    max-width: 1200px;
    margin: auto;
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 16px;
}

.grid-item {
    overflow: hidden;
    border-radius: 8px;
}

.grid-image {
    width: 100%;
    display: block;
}

/* Swatches */
.swatches {
    display: flex;
    gap: 12px;
    margin: 20px 0;
    justify-content: center;
}

.swatch {
    width: 42px;
    height: 42px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid #ccc;
}

.swatch.active {
    border-color: #000;
}
</style>

<!-- =====================
     CANVAS SCRIPT
     ===================== -->
<script>
require(['jquery'], function ($) {

    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');

    /* ---------- Parse rectangle from ALT ---------- */
    function parseRect(alt) {
        const rect = { x: 0.35, y: 0.35, w: 0.3, h: 0.3 };
        if (!alt) return rect;

        alt.split(';').forEach(part => {
            const [key, val] = part.split('=');
            if (rect.hasOwnProperty(key)) {
                const num = parseFloat(val);
                if (!isNaN(num)) rect[key] = num;
            }
        });
        return rect;
    }

    function waitForImage(img) {
        return new Promise(resolve => {
            if (img.complete && img.naturalWidth > 0) resolve();
            else img.onload = resolve;
        });
    }

    /* ---------- Color rectangle processor ---------- */
    function processColor(src, rect, color) {
        return new Promise(resolve => {

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = src.split('?')[0];

            img.onload = () => {
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.7;
                ctx.fillStyle = color;
                ctx.fillRect(
                    canvas.width * rect.x,
                    canvas.height * rect.y,
                    canvas.width * rect.w,
                    canvas.height * rect.h
                );
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;

                resolve(canvas.toDataURL('image/png'));
            };
        });
    }

    /* ---------- Full grayscale processor ---------- */
    function processBW(src) {
        return new Promise(resolve => {

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = src.split('?')[0];

            img.onload = () => {
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;

                ctx.drawImage(img, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const d = imageData.data;

                for (let i = 0; i < d.length; i += 4) {
                    const avg = (d[i] + d[i + 1] + d[i + 2]) / 3;
                    d[i] = d[i + 1] = d[i + 2] = avg;
                }

                ctx.putImageData(imageData, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
        });
    }

    /* ---------- Apply color to ALL images ---------- */
    async function applyColor(color) {
        for (const img of document.querySelectorAll('.grid-image')) {
            await waitForImage(img);
            img.dataset.originalSrc ||= img.src;
            const rect = parseRect(img.alt);
            img.src = await processColor(img.dataset.originalSrc, rect, color);
        }
    }

    /* ---------- Apply BW to ALL images ---------- */
    async function applyBW() {
        for (const img of document.querySelectorAll('.grid-image')) {
            await waitForImage(img);
            img.dataset.originalSrc ||= img.src;
            img.src = await processBW(img.dataset.originalSrc);
        }
    }

    function resetImages() {
        document.querySelectorAll('.grid-image').forEach(img => {
            if (img.dataset.originalSrc) {
                img.src = img.dataset.originalSrc;
            }
        });
    }

    /* ---------- Swatch click ---------- */
    $('.swatch').on('click', async function () {
        $('.swatch').removeClass('active');
        $(this).addClass('active');

        const action = $(this).data('action');
        const color  = $(this).data('color');

        if (action === 'reset') return resetImages();
        if (action === 'bw') return await applyBW();
        if (color) await applyColor(color);
    });

});
</script>
